!function(a,b){"use strict";b["true"]=a,angular.module("ya.treeview",[]).factory("YaTreeviewService",["$q",function(a){var b={},c=function(a,b){return angular.isArray(a[b.childrenKey])||a[b.hasChildrenKey]||!1};return b.children=function(b,c){var d=a.defer(),e=b.$model[c.childrenKey];return angular.isFunction(e)?a.when(e()).then(function(a){d.resolve(a)}):angular.isArray(e)?d.resolve(e):d.reject(new Error("Children is neither an array nor a function.")),d.promise},b.nodify=function(d,e,f){var g=a.defer(),h={$model:d,$parent:e,$hasChildren:c(d,f),collapsed:!f.expanded};return h.$hasChildren?f.expanded?a.when(b.children(h,f)).then(function(a){b.nodifyArray(a,h,f).then(function(a){h.$children=a,g.resolve(h)})}):(h.$children=[],g.resolve(h)):g.resolve(h),g.promise},b.nodifyArray=function(c,d,e){var f=a.defer(),g=[],h=[];return angular.forEach(c,function(c){var f=a.defer();b.nodify(c,d,e).then(function(a){h.push(a),f.resolve()}),g.push(f)}),a.all(g).then(function(){f.resolve(h)}),f.promise},b}]).controller("YaTreeviewCtrl",["$scope","$timeout","YaTreeviewService","$q",function(a,b,c,d){var e,f=function(a){var b={};return a=a||{},b.childrenKey=a.childrenKey||"children",b.hasChildrenKey=a.hasChildrenKey||"has_children",b.onExpand=a.onExpand||angular.noop,b.onCollapse=a.onCollapse||angular.noop,b.onSelect=a.onSelect||angular.noop,b.onDblClick=a.onDblClick||angular.noop,b.expanded=!!a.expanded,b},g=function(a,f){var g=d.defer();return a.$hasChildren&&b(function(){angular.forEach(a.$children,function(a){a.$hasChildren&&d.when(c.children(a,e)).then(function(b){a.$children=f||c.nodifyArray(b,a,e),g.resolve()})})}),g.promise},h=function(a){var b=d.defer(),f={};return f[e.childrenKey]=a,c.nodify(f,null,e).then(function(d){console.log("in createRootNode nodify response");var f=d;c.nodifyArray(a,f,e).then(function(a){console.log("in createRootNode nodifyArray response"),f.$children=a,g(f).then(function(){f.collapsed=!1,b.resolve(f)})})}),b.promise};a.init=function(){var b=d.defer();return e=f(a.options),e.expanded=!1,h(a.model).then(function(c){console.log("rootNode: "),console.log(c),a.node=c,a.context=a.context||{},a.context.rootNode=a.node,a.context.nodify=i,a.context.nodifyArray=j,a.context.children=k,b.resolve()}),b.promise},a.toggle=function(b,c){c.collapsed?a.expand(b,c):a.collapse(b,c)},a.expand=function(b,c){var f=d.defer();return g(c).then(function(){c.collapsed=!1,e.onExpand(b,c,a.context),f.resolve()}),f.promise},a.collapse=function(b,c){c.collapsed=!0,g(c,[]),angular.forEach(c.$children,function(a){a.collapsed=!0}),e.onCollapse(b,c,a.context)},a.selectNode=function(b,c){a.context.selectedNode=c,e.onSelect(b,c,a.context)},a.dblClick=function(b,c){e.onDblClick(b,c,a.context)};var i=function(a,b){var f=d.defer();return c.nodify(a,b,e).then(function(a){f.resolve(a)}),f.promise},j=function(a,b){var f=d.defer();return c.nodifyArray(a,b,e).then(function(a){f.resolve(a)}),f.promise},k=function(a){var b=d.defer();return c.children(a,e).then(function(a){b.resolve(a)}),b.promise};a.$watch("model",function(b,c){b!==c&&(a.node=h(b))}),a.$watch("context.selectedNode",function(b){a.selectNode({},b)}),a.init()}]).directive("yaTreeview",function(){return{restrict:"AE",replace:!0,transclude:!0,controller:"YaTreeviewCtrl",scope:{id:"@yaId",model:"=yaModel",options:"=yaOptions",context:"=yaContext"},templateUrl:"templates/ya-treeview/treeview.tpl.html",compile:function(a,b,c){return function(a,b,d,e){e.transcludeFn=c}}}}).directive("yaNode",["$compile",function(a){return{restrict:"AE",replace:!1,scope:!1,templateUrl:"templates/ya-treeview/children.tpl.html",compile:function(b){var c=b.clone();return b.empty(),function(b,d){b.node.$hasChildren&&d.append(a(c.html())(b))}}}}]).directive("yaTransclude",function(){return{restrict:"AE",replace:!1,require:"^yaTreeview",scope:!1,template:"",link:function(a,b,c,d){d.transcludeFn(a,function(c){a.node&&b.append(c)})}}})}({},function(){return this}());